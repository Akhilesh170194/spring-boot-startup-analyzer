<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot Startup Analyzer</title>
    <style>
        :root {
            --color-bg: #f8f9fa;
            --color-surface: #ffffff;
            --color-text: #212529;
            --color-primary: #0d6efd;
            --color-success: #198754;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-border: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #1a1a1a;
                --color-surface: #2d2d2d;
                --color-text: #e9ecef;
                --color-primary: #4dabf7;
                --color-success: #51cf66;
                --color-warning: #ffd43b;
                --color-danger: #ff6b6b;
                --color-border: #495057;
                --shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
        }

        [data-theme="dark"] {
            --color-bg: #1a1a1a;
            --color-surface: #2d2d2d;
            --color-text: #e9ecef;
            --color-primary: #4dabf7;
            --color-success: #51cf66;
            --color-warning: #ffd43b;
            --color-danger: #ff6b6b;
            --color-border: #495057;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        [data-theme="light"] {
            --color-bg: #f8f9fa;
            --color-surface: #ffffff;
            --color-text: #212529;
            --color-primary: #0d6efd;
            --color-success: #198754;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-border: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
        }

        .header {
            background: var(--color-surface);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: var(--color-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .input-section {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0b5ed7;
        }

        .summary {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .summary h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 6px;
            background: var(--color-bg);
            border-left: 4px solid var(--color-primary);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-card.active {
            border: 1px solid var(--color-primary);
            background: var(--color-surface);
        }

        .stat-card.warning {
            border-left-color: var(--color-warning);
        }

        .stat-card.warning.active {
            border-color: var(--color-warning);
        }

        .stat-card.danger {
            border-left-color: var(--color-danger);
        }

        .stat-card.danger.active {
            border-color: var(--color-danger);
        }

        .stat-card.success {
            border-left-color: var(--color-success);
        }

        .stat-card.success.active {
            border-color: var(--color-success);
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
        }

        .timeline {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .timeline h2 {
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            background: var(--color-bg);
            transition: all 0.2s;
            cursor: pointer;
        }

        .timeline-item:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        @media (prefers-color-scheme: dark) {
            .timeline-item:hover {
                background: rgba(255, 255, 255, 0.05);
            }
        }

        [data-theme="dark"] .timeline-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .timeline-bar {
            min-width: 4px;
            border-radius: 2px;
        }

        .timeline-bar.fast {
            background: var(--color-success);
        }

        .timeline-bar.normal {
            background: var(--color-primary);
        }

        .timeline-bar.slow {
            background: var(--color-warning);
        }

        .timeline-bar.critical {
            background: var(--color-danger);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .timeline-name {
            font-weight: 500;
            font-size: 14px;
        }

        .timeline-duration {
            font-weight: 600;
            font-size: 14px;
        }

        .timeline-details {
            font-size: 12px;
            color: #6c757d;
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--color-border);
        }

        .timeline-item.expanded .timeline-details {
            display: block;
        }

        .timeline-children {
            display: none;
            margin-left: 20px;
        }

        .timeline-children.show {
            display: block;
        }

        .collapse-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s;
            font-size: 12px;
        }

        .timeline-item.children-expanded .collapse-icon {
            transform: rotate(90deg);
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-warning {
            background: #fff3cd;
            color: #997404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #842029;
        }

        .badge-info {
            background: #cfe2ff;
            color: #084298;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--color-text);
        }

        .expand-toggle {
            color: var(--color-primary);
            font-size: 12px;
            margin-left: auto;
        }

        .issue-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .issue-icon.warning {
            background: var(--color-warning);
        }

        .issue-icon.critical {
            background: var(--color-danger);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--color-bg);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <h1>
                <div class="logo">⚡</div>
                Spring Boot Startup Analyzer
            </h1>
            <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
        </div>
    </div>

    <div class="container">
        <div class="input-section">
            <div class="input-group">
                <input type="text" id="endpointUrl" placeholder="http://localhost:8080/actuator/startup" value="http://localhost:7811/api/actuator/startup">
                <button class="btn btn-primary" onclick="analyzeStartup()">Analyze</button>
                <label style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
                    <input type="checkbox" id="expandAll"> Expand All
                </label>
            </div>
        </div>

        <div id="summarySection" style="display: none;">
            <div class="summary">
                <h2>
                    <span>Startup Summary</span>
                    <span style="font-size: 14px; font-weight: normal; color: #6c757d;">Total Duration: <span id="totalDuration" style="color: var(--color-text); font-weight: 600;">0s</span></span>
                </h2>
                <div class="stats-grid">
                    <div class="stat-card active" onclick="filterByCard('all')" data-filter="all">
                        <div class="stat-label">Total Steps</div>
                        <div class="stat-value" id="totalSteps">0</div>
                    </div>
                    <div class="stat-card warning" onclick="filterByCard('slow')" data-filter="slow">
                        <div class="stat-label">Slow Steps</div>
                        <div class="stat-value" id="slowSteps">0</div>
                    </div>
                    <div class="stat-card danger" onclick="filterByCard('critical')" data-filter="critical">
                        <div class="stat-label">Critical Issues</div>
                        <div class="stat-value" id="criticalIssues">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="timelineSection" style="display: none;">
            <div class="timeline">
                <h2>
                    <span>Startup Timeline</span>
                </h2>
                <div id="timelineContent"></div>
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <h3>No Data Available</h3>
            <p>Enter your /actuator/startup endpoint URL and click Analyze to view detailed startup metrics</p>
        </div>

        <div id="loadingState" class="loading" style="display: none;">
            <h3>Analyzing...</h3>
            <p>Fetching startup data from endpoint</p>
        </div>
    </div>

    <script>
        // Application state
        const AppState = {
            startupData: null,
            elements: {},
            allSteps: [],
            
            init() {
                this.elements = {
                    endpointUrl: document.getElementById('endpointUrl'),
                    expandAll: document.getElementById('expandAll'),
                    filterSelect: document.getElementById('filterSelect'),
                    emptyState: document.getElementById('emptyState'),
                    loadingState: document.getElementById('loadingState'),
                    summarySection: document.getElementById('summarySection'),
                    timelineSection: document.getElementById('timelineSection'),
                    totalDuration: document.getElementById('totalDuration'),
                    totalSteps: document.getElementById('totalSteps'),
                    slowSteps: document.getElementById('slowSteps'),
                    criticalIssues: document.getElementById('criticalIssues'),
                    timelineContent: document.getElementById('timelineContent')
                };
                
                this.bindEvents();
            },
            
            bindEvents() {
                this.elements.expandAll.addEventListener('change', UIManager.handleExpandAllChange);
            }
        };

        // Step descriptions and utilities
        const StepUtils = {
            descriptions: {
                'spring.boot.application.starting': 'The Spring Boot application is starting. This includes initial launch code.',
                'spring.boot.application.environment-prepared': 'The application environment is prepared. Configuration from application.properties, environment variables, etc. is loaded.',
                'spring.boot.application.context-prepared': 'The application context (Spring container) is created but not yet loaded with beans.',
                'spring.boot.application.context-loaded': 'The application context is loaded. All beans and configuration classes are registered.',
                'spring.boot.application.started': 'The context has been refreshed and startup sequence completed.',
                'spring.boot.application.ready': 'Spring application is fully started and ready for requests. Application runners execute now.',
                'spring.beans.instantiate': 'Creating an individual Bean instance as part of dependency injection.',
                'spring.beans.smart-initialize': 'Running special initialization for beans with SmartInitializingSingleton interface.',
                'spring.beans.post-process': 'Running BeanPostProcessors to customize beans after initialization.',
                'spring.context.base-packages.scan': 'Scanning packages for annotated components (@Component, @Service, etc.).',
                'spring.context.refresh': 'The ApplicationContext is fully initialized and refreshed.',
                'spring.boot.web-application-type-detect': 'Detecting application type (servlet, reactive, or non-web).',
                'spring.boot.web.server.start': 'Starting embedded web server (Tomcat, Jetty, etc.).'
            },

            getDescription(stepName) {
                return this.descriptions[stepName] || 'Internal Spring Boot startup phase.';
            },

            // Parse ISO 8601 duration (PT0.0422197S format) to milliseconds
            parseDuration(durationStr) {
                if (!durationStr) return 0;
                if (typeof durationStr === 'number') return durationStr;
                
                const match = durationStr.match(/PT([\d.]+)S/);
                if (match) {
                    return parseFloat(match[1]) * 1000;
                }
                return 0;
            },

            formatDuration(ms) {
                if (ms < 1000) return ms.toFixed(0) + 'ms';
                return (ms / 1000).toFixed(2) + 's';
            },

            getSeverity(duration, avgDuration) {
                if (duration > avgDuration * 3) return 'critical';
                if (duration > avgDuration * 2) return 'slow';
                if (duration > 1000) return 'normal';
                return 'fast';
            },

            getSeverityColor(severity) {
                const colors = {
                    fast: 'var(--color-success)',
                    normal: 'var(--color-primary)',
                    slow: 'var(--color-warning)',
                    critical: 'var(--color-danger)'
                };
                return colors[severity] || 'var(--color-primary)';
            }
        };

        // UI management functions
        const UIManager = {
            handleExpandAllChange(event) {
                const items = document.querySelectorAll('.timeline-item');
                items.forEach(item => {
                    if (event.target.checked) {
                        item.classList.add('expanded');
                    } else {
                        item.classList.remove('expanded');
                    }
                });
            },

            showLoading() {
                AppState.elements.emptyState.style.display = 'none';
                AppState.elements.loadingState.style.display = 'block';
                AppState.elements.summarySection.style.display = 'none';
                AppState.elements.timelineSection.style.display = 'none';
            },

            showResults() {
                AppState.elements.loadingState.style.display = 'none';
                AppState.elements.summarySection.style.display = 'block';
                AppState.elements.timelineSection.style.display = 'block';
            },

            showError(message) {
                AppState.elements.loadingState.style.display = 'none';
                AppState.elements.emptyState.style.display = 'block';
                AppState.elements.emptyState.innerHTML = `
                    <h3>Error Loading Data</h3>
                    <p>${message}</p>
                `;
            }
        };

        // Filter management
        const FilterManager = {
            currentFilter: 'all',
            
            applyFilter(filterValue) {
                this.currentFilter = filterValue;
                const items = document.querySelectorAll('.timeline-item');
                
                items.forEach(item => {
                    const isCritical = item.querySelector('.badge[data-severity="critical"]') !== null;
                    const isSlow = item.querySelector('.badge[data-severity="slow"]') !== null;
                    
                    let shouldShow = false;
                    
                    switch(filterValue) {
                        case 'all':
                            shouldShow = true;
                            break;
                        case 'critical':
                            shouldShow = isCritical;
                            break;
                        case 'slow':
                            shouldShow = isSlow;
                            break;
                        case 'issues':
                            shouldShow = isCritical || isSlow;
                            break;
                    }
                    
                    item.style.display = shouldShow ? 'flex' : 'none';
                });
                
                // Update active state on cards
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.remove('active');
                });
                const activeCard = document.querySelector(`.stat-card[data-filter="${filterValue}"]`);
                if (activeCard) {
                    activeCard.classList.add('active');
                }
            }
        };

        // Card click handler for filtering
        function filterByCard(filterType) {
            FilterManager.applyFilter(filterType);
        }

        // Data processing
        const DataProcessor = {
            calculateMetrics(events) {
                let totalDuration = 0;
                if (events.length > 0) {
                    const firstStart = new Date(events[0].startTime).getTime();
                    const lastEnd = new Date(events[events.length - 1].endTime).getTime();
                    totalDuration = lastEnd - firstStart;
                }
                
                const totalSteps = events.length;
                let slowSteps = 0;
                let criticalIssues = 0;
                
                let totalMs = 0;
                const durations = events.map(e => {
                    const ms = StepUtils.parseDuration(e.duration);
                    totalMs += ms;
                    return ms;
                });
                const avgDuration = totalMs / totalSteps;
                
                events.forEach((event, idx) => {
                    const duration = durations[idx];
                    if (duration > avgDuration * 2) slowSteps++;
                    if (duration > avgDuration * 3) criticalIssues++;
                });

                return {
                    totalDuration,
                    totalSteps,
                    slowSteps,
                    criticalIssues,
                    avgDuration
                };
            },

            updateSummary(metrics) {
                AppState.elements.totalDuration.textContent = StepUtils.formatDuration(metrics.totalDuration);
                AppState.elements.totalSteps.textContent = metrics.totalSteps;
                AppState.elements.slowSteps.textContent = metrics.slowSteps;
                AppState.elements.criticalIssues.textContent = metrics.criticalIssues;
            }
        };

        // Main application functions
        async function analyzeStartup() {
            const url = AppState.elements.endpointUrl.value;
            
            if (!url) {
                alert('Please enter an endpoint URL');
                return;
            }

            UIManager.showLoading();

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch startup data');
                
                const data = await response.json();
                AppState.startupData = data;
                processAndDisplay(data);
            } catch (error) {
                UIManager.showError(error.message);
            }
        }

        function processAndDisplay(data) {
            UIManager.showResults();

            const timeline = data.timeline || {};
            const events = timeline.events || [];
            
            const metrics = DataProcessor.calculateMetrics(events);
            DataProcessor.updateSummary(metrics);
            TimelineRenderer.render(events, metrics.totalDuration, metrics.avgDuration);
        }

        // Theme management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const btn = document.querySelector('.theme-toggle');
            btn.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

        // Initialize theme from localStorage or system preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-theme', theme);
            
            const btn = document.querySelector('.theme-toggle');
            if (btn) {
                btn.textContent = theme === 'dark' ? '☀️' : '🌙';
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            initTheme();
        });

        // Timeline rendering (continued from previous section)
        const TimelineRenderer = {
            render(events, totalDuration, avgDuration) {
                const container = AppState.elements.timelineContent;
                container.innerHTML = '';

                const parentMap = this.buildParentMap(events);
                const rootEvents = this.getRootEvents(events);
                
                rootEvents.forEach((event, index) => {
                    this.renderEvent(event, index, totalDuration, avgDuration, 0, parentMap, container);
                });
            },

            buildParentMap(events) {
                const parentMap = {};
                events.forEach(event => {
                    const parentId = event.startupStep?.parentId;
                    if (parentId !== undefined) {
                        if (!parentMap[parentId]) parentMap[parentId] = [];
                        parentMap[parentId].push(event);
                    }
                });
                return parentMap;
            },

            getRootEvents(events) {
                return events.filter(e => 
                    e.startupStep?.parentId === undefined || 
                    e.startupStep?.parentId === null || 
                    !events.find(ev => ev.startupStep?.id === e.startupStep?.parentId)
                );
            },

            renderEvent(event, index, totalDuration, avgDuration, level, parentMap, parentContainer) {
                const duration = StepUtils.parseDuration(event.duration);
                const severity = StepUtils.getSeverity(duration, avgDuration);
                const badge = this.createSeverityBadge(severity);
                
                const step = event.startupStep || {};
                const children = parentMap[step.id] || [];
                const hasChildren = children.length > 0;
                
                const item = this.createTimelineItem(event, step, duration, severity, badge, hasChildren, level, totalDuration);
                parentContainer.appendChild(item);
                
                if (hasChildren) {
                    this.handleParentItem(item, children, index, totalDuration, avgDuration, level, parentMap, parentContainer);
                } else {
                    this.handleLeafItem(item);
                }
            },

            createSeverityBadge(severity) {
                const badges = {
                    critical: '<span class="badge badge-danger" data-severity="critical">CRITICAL</span>',
                    slow: '<span class="badge badge-warning" data-severity="slow">SLOW</span>'
                };
                return badges[severity] || '';
            },

            createTimelineItem(event, step, duration, severity, badge, hasChildren, level, totalDuration) {
                const percentage = (duration / totalDuration) * 100;
                const tags = this.formatTags(step.tags || {});
                const stepDesc = StepUtils.getDescription(step.name);
                
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.style.marginLeft = (level * 20) + 'px';
                
                item.innerHTML = `
                    <div class="timeline-bar ${severity}"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <div class="timeline-name">
                                ${hasChildren ? '<span class="collapse-icon">▶</span>' : ''}
                                ${severity === 'critical' ? '<span class="issue-icon critical"></span>' : ''}
                                ${severity === 'slow' ? '<span class="issue-icon warning"></span>' : ''}
                                <span>${step.name || 'Step ' + (step.id !== undefined ? step.id : 'N/A')}</span>
                                ${badge}
                                <span class="timeline-duration" style="margin-left: 10px;">${StepUtils.formatDuration(duration)}</span>
                            </div>
                            <div class="expand-toggle">Details ▼</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${severity}" style="width: ${Math.min(percentage * 2, 100)}%; background: ${StepUtils.getSeverityColor(severity)}"></div>
                        </div>
                        <div class="timeline-details">
                            <strong>Description:</strong><br>
                            <div style="color: #495057; margin-bottom: 10px; line-height: 1.5;">${stepDesc}</div>
                            <strong>Details:</strong><br>
                            Step ID: ${step.id !== undefined ? step.id : 'N/A'}<br>
                            ${step.parentId !== undefined ? `Parent ID: ${step.parentId}<br>` : ''}
                            Start Time: ${event.startTime ? new Date(event.startTime).toLocaleTimeString() : 'N/A'}<br>
                            End Time: ${event.endTime ? new Date(event.endTime).toLocaleTimeString() : 'N/A'}<br>
                            ${tags ? `<br><strong>Tags:</strong><br>${tags}` : ''}
                            ${this.getSeverityWarning(severity)}
                        </div>
                    </div>
                `;
                
                return item;
            },

            formatTags(tags) {
                return Object.entries(tags)
                    .map(([k,v]) => `<span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 4px;">${k}: ${v}</span>`)
                    .join(' ');
            },

            getSeverityWarning(severity) {
                const warnings = {
                    critical: '<br><br><strong style="color: var(--color-danger);">⚠ This step took significantly longer than average and may need optimization</strong>',
                    slow: '<br><br><strong style="color: var(--color-warning);">⚠ This step is slower than expected</strong>'
                };
                return warnings[severity] || '';
            },

            handleParentItem(item, children, index, totalDuration, avgDuration, level, parentMap, parentContainer) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'timeline-children';
                
                children.forEach((child, idx) => {
                    this.renderEvent(child, idx, totalDuration, avgDuration, level + 1, parentMap, childrenContainer);
                });
                
                parentContainer.appendChild(childrenContainer);
                this.addParentClickHandlers(item, childrenContainer);
            },

            handleLeafItem(item) {
                item.addEventListener('click', function(e) {
                    item.classList.toggle('expanded');
                });
            },

            addParentClickHandlers(item, childrenContainer) {
                let clickTimer = null;
                item.addEventListener('click', function(e) {
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            // Single click - toggle details
                            item.classList.toggle('expanded');
                            clickTimer = null;
                        }, 250);
                    } else {
                        // Double click - toggle children
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        const isExpanded = childrenContainer.classList.contains('show');
                        const collapseIcon = item.querySelector('.collapse-icon');
                        if (collapseIcon) {
                            collapseIcon.style.transform = isExpanded ? '' : 'rotate(90deg)';
                        }
                        childrenContainer.classList.toggle('show');
                    }
                });
            }
        };

        // Legacy functions for backward compatibility
        function parseDuration(durationStr) {
            return StepUtils.parseDuration(durationStr);
        }

        function formatDuration(ms) {
            return StepUtils.formatDuration(ms);
        }

        function getColorForSeverity(severity) {
            return StepUtils.getSeverityColor(severity);
        }

        function getStepDescription(stepName) {
            return StepUtils.getDescription(stepName);
        }
    </script>
</body>
</html>
